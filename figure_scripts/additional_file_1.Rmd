---
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r warning=FALSE}
library(png)
library(ggplot2)
library(ggpubr)
library(ggupset)
library(scales)
library(patchwork)
library(tools)
suppressMessages(library(tidyverse))
theme_set(theme_bw())

source("shared_funcs.R")
```

```{r}
fig_S1 <- load_image_as_panel("../figures/fig_S1.png")
fig_S1_width <- 7.5
fig_S1_height <- unit(fig_S1_width * fig_S1[[2]], "in")
```

```{r fig.height=fig_S1_height, fig.width=ggplot2::unit(fig_S1_width,"in")}
fig_S1[[1]]
```

**Supplementary Figure 1. Escher map of a pathway of reactions flagged by the dead-end test in version 9.0.0 of yeast-GEM.**

\newpage

```{r}
fig_S2_width <- 7.5
fig_S2bc_height <- 2.5
yeast_results <- read_csv(
  "../figure_data/yeast-GEMv9.0.0_test-results.csv", show_col_types = FALSE
) %>% select(-diphosphate_test)
fig_S2_stuff <- load_image_as_panel("../figures/fig_S2a.png")
fig_S2a_height <- (fig_S2_width * (fig_S2_stuff[[2]]))
fig_S2a <- fig_S2_stuff[[1]] + theme(plot.tag.position = c(-0.001,0.98))
fig_S2b <- make_hists(yeast_results, 1300, 300) +
  theme(
    plot.tag.position = c(-0.13, 1.06),
    plot.margin = unit(c(0,0,0.1,0), "in")
  )
fig_S2c <- make_upset(yeast_results) +
  theme(
    plot.tag.position = c(-0.26, 0.95),
    plot.margin = unit(c(0,0.05,0.1,0.52), "in")
  )
fig_S2 <- (fig_S2a / (free(fig_S2b) | free(fig_S2c))) +
  plot_layout(heights = unit(c(fig_S2a_height, fig_S2bc_height), "in")) +
  plot_annotation(tag_levels = "A") &
  theme(
    plot.tag.location = "panel",
    plot.tag = element_text(size = 8, face = "bold")
  )
fig_S2_height <- unit(fig_S2a_height + fig_S2bc_height, "in")
```

```{r fig.height=fig_S2_height, fig.width=ggplot2::unit(fig_S2_width, "in")}
fig_S2
```

**Supplementary Figure 2. Overview of reactions in version 9.0.0 of yeast-GEM flagged by one or more tests in MACAW.** (A) Each node represents a single reaction; see Methods for explanation of how reactions were connected. The color of each node indicates which test(s) the reaction was flagged by. (B) Distributions of numbers of reactions in each connected component ("pathway") shown in a. for all pathways or only pathways containing at least one reaction flagged by the specified test. (C) UpSET plot showing number of reactions flagged by each observed combination of tests in MACAW.

\newpage

```{r}
fig_S3_width <- 7.5
fig_S3bc_height <- 2.75
ecoli_results <- read_csv(
  "../figure_data/iML1515_test-results.csv", show_col_types = FALSE
) %>% select(-diphosphate_test)
fig_S3_stuff <- load_image_as_panel("../figures/fig_S3a.png")
fig_S3a_height <- (fig_S3_width * (fig_S3_stuff[[2]]))
fig_S3a <- fig_S3_stuff[[1]] +
  theme(
    plot.tag.position = c(0.005,0.99),
    plot.margin = unit(c(0,0,0,0), "in")
  )
fig_S3b <- make_hists(ecoli_results, 1000, 125) +
  theme(
    plot.tag.position = c(-0.13,1.09),
    plot.margin = unit(c(0,0,0.1,0), "in")
  )
fig_S3c <- make_upset(ecoli_results) +
  theme(
    plot.tag.position = c(-0.25,0.95),
    plot.margin = unit(c(0,0,0.1,0.52), "in")
  )
fig_S3 <- (fig_S3a / (free(fig_S3b) | free(fig_S3c))) +
  plot_layout(heights = unit(c(fig_S3a_height, fig_S3bc_height), "in")) +
  plot_annotation(tag_levels = "A") &
  theme(
    plot.tag = element_text(size = 8, face = "bold"),
    plot.tag.location = "panel"
  )
fig_S3_height <- unit(fig_S3a_height + fig_S3bc_height, "in")
```

```{r fig.height=fig_S3_height, fig.width=ggplot2::unit(fig_S3_width, "in")}
fig_S3
```

**Supplementary Figure 3. Overview of reactions in iML1515 flagged by one or more tests in MACAW.** (A) Each node represents a single reaction; see Methods for explanation of how reactions were connected. The color of each node indicates which test(s) the reaction was flagged by. (B) Distributions of numbers of reactions in each connected component ("pathway") shown in a. for all pathways or only pathways containing at least one reaction flagged by the specified test. (C) UpSET plot showing number of reactions flagged by each observed combination of tests in MACAW.

\newpage

```{r fig.height=ggplot2::unit(7.5,"in"), fig.width=ggplot2::unit(4.25,"in")}
# get the summarized test results for all versions of Human-GEM
fig_S4a_data_raw <- read_csv(
  "../figure_data/fig_S4a_data.csv", show_col_types = FALSE, col_types = "fiiiii"
)
# get the simplified test results for only versions 1.15 and 1.18 of Human-GEM
# that have reactions annotated by KEGG group
fig_S4b_data_raw <- read_csv("../figure_data/fig_S4b_data.csv", show_col_types = F)

fig_S4a_data <- fig_S4a_data_raw %>%
  # replace counts with proportions, then drop the counts
  mutate(any_prop = flagged/all_rxns) %>%
  mutate(dead_prop = `dead-ends`/all_rxns) %>%
  mutate(dil_prop = `dilution-blocked`/all_rxns) %>%
  mutate(dupe_prop = duplicates/all_rxns) %>%
  mutate(loop_prop = loops/all_rxns) %>%
  select(
    -all_rxns, -flagged, -`dead-ends`, -`dilution-blocked`, -duplicates, -loops,
    -redoxes
  ) %>%
  # pivot cuz it'll be easier to plot this way
  pivot_longer(-model_version, names_to = "test", values_to = "prop") %>%
  # make more human-readable for figure
  mutate(test = case_when(
    test == "any_prop" ~ "Any Test",
    test == "dead_prop" ~ "Dead-End Test",
    test == "dil_prop" ~ "Dilution Test",
    test == "dupe_prop" ~ "Duplicate Test",
    test == "loop_prop" ~ "Loop Test"
  )) %>%
  mutate(model_version = factor(model_version, levels = c(
    "1.0", "1.1", "1.2", "1.3", "1.4", "1.5", "1.6", "1.7", "1.8", "1.9",
    "1.10", "1.11", "1.12", "1.13", "1.14", "1.15", "1.16", "1.17", "1.18"
  ))) %>%
  arrange(model_version)

# label every other version
fig_S4a_labs <- unique(as.character(fig_S4a_data$model_version))
fig_S4a_labs[c(FALSE, TRUE)] <- ""

fig_S4a <- ggplot(
  fig_S4a_data, aes(x = model_version, y = prop, col = test, group = test)
) +
  geom_line() +
  scale_x_discrete(labels = c(fig_S4a_labs)) +
  scale_color_manual(
    values = c("#8DD3C7", "#FB8072", "#B3DE69", "#FCCDE5", "#80B1D3"),
    guide = guide_legend(
      keyheight = 5, keywidth = 5, default.unit = "mm", byrow = TRUE
    )
  ) +
  labs(
    x = "Version of Human-GEM",
    y = "Prop. of All Reactions",
    col = "Flagged by"
  ) +
  theme(
    axis.text = element_text(color = "black", size = 6),
    axis.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 8, hjust = 0.5),
    legend.spacing.y = unit(0, "mm"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.margin = unit(c(0,1,0,0), "mm")
  )

fig_S4b_data_1 <- fig_S4b_data_raw %>%
  group_by(Version, kegg_group) %>%
  summ_func()

fig_S4b_data_2 <- fig_S4b_data_raw %>%
  # drop KEGG group and filter out duplicate rows since many reactions were
  # associated with multiple KEGG groups and we don't want to double-count them
  select(-kegg_group) %>%
  distinct() %>%
  group_by(Version) %>%
  summ_func() %>%
  mutate(kegg_group = "All Reactions")

fig_S4b_data <- bind_rows(fig_S4b_data_1, fig_S4b_data_2) %>%
  pivot_longer(
    c(
      any_pct,
      dead_end_pct,
      dilution_pct,
      duplicate_pct,
      loop_pct
    ), names_to = "test", values_to = "pct_rxns"
  ) %>%
  # make first two levels "All Reactions" then "Not in KEGG"
  mutate(kegg_group = relevel(as.factor(kegg_group), "Not in KEGG")) %>%
  mutate(kegg_group = relevel(kegg_group, "All Reactions")) %>%
  mutate(test = gsub("_pct", " test", test)) %>%
  mutate(test = gsub("dead_end", "dead-end", test)) %>%
  mutate(test = gsub("any", "Any", test)) %>%
  mutate(test = toTitleCase(test)) %>%
  mutate(test = factor(test, c(
    "Any Test", "Dead-End Test", "Dilution Test", "Duplicate Test", "Loop Test"
  ))) %>%
  mutate(Version = as.factor(Version))

# make a separate dataframe of coordinates to use for grey rectangles to put
# behind every other group of bars instead of using normal gridlines
rect_df <- data.frame(
  starts = seq(0.5, n_distinct(fig_S4b_data$kegg_group), by = 2),
  ends = seq(1.5, n_distinct(fig_S4b_data$kegg_group)+1, by = 2)
)

fig_S4b <- ggplot() +
  scale_x_discrete() +
  geom_rect(
    data = rect_df,
    mapping = aes(xmin = starts, xmax = ends),
    ymin = -Inf,
    ymax = Inf,
    fill = "gray",
    color = NA,
    alpha = 0.5
  ) +
  geom_bar(
    data = fig_S4b_data,
    mapping = aes(x = kegg_group, y = pct_rxns, fill = Version),
    stat = "identity",
    position = "dodge",
    width = 0.6
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  facet_grid(rows = vars(test), scales = "free_y") +
  labs(x = "Metabolism of ___", y = "% Reactions in Group") +
  theme(
    text = element_text(color = "black", size = 8),
    strip.text = element_text(size = 8),
    axis.text = element_text(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.background = element_blank(),
    strip.clip = "off",
    panel.grid = element_blank(),
    legend.key.size = unit(1/8, "in"),
    legend.title = element_text(hjust = 0.5),
    legend.box.spacing = unit(0, "in")
  )

(free(fig_S4a) / free(fig_S4b)) +
  plot_layout(heights = c(1,3.5)) +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 8, face = "bold"))
```

**Supplementary Figure 4. Test Results Between Different Versions of Human-GEM.** (A) Proportions of reactions flagged by tests across all versions of Human-GEM. (B) Proportions of reactions flagged by tests in versions 1.15 and 1.18 of Human-GEM. Reactions grouped according to the second-highest levels of the KEGG functional ortholog hierarchy containing the genes associated with each reaction; see **Methods**. Individual reactions may be associated with more than one group of KEGG functional orthologs. Names of KEGG functional ortholog groups have been abbreviated.

\newpage

```{r fig.height=ggplot2::unit(1.5,"in"), fig.width=ggplot2::unit(6.5,"in")}
fig_S5a <- load_image_as_panel("../figures/fig_S5a.png")[[1]] +
  theme(plot.tag.position = c(-0.05, 0.91))
fig_S5b <- load_image_as_panel("../figures/fig_S5b.png")[[1]] +
  theme(plot.tag.position = c(0, 0.91))
fig_S5c <- load_image_as_panel("../figures/fig_S5c.png")[[1]] +
  theme(plot.tag.position = c(0, 0.91))

(free(fig_S5a) | free(fig_S5b) | free(fig_S5c)) +
  plot_layout(widths = c(1,1.25, 1.25)) +
  plot_annotation(tag_levels = "A") &
  theme(
    plot.tag = element_text(size = 8, face = "bold"),
    plot.tag.location = "panel",
  )
```

**Supplementary Figure 5. "Leakage" reactions prevent the dilution test from flagging unproblematic antiport reactions.** (A) Toy model with two metabolites that can exist in two different compartments: "out" and "in", and move between them via the antiport reaction v2. Numbers in parentheses next to reaction labels are the minimum and maximum allowed fluxes through that reaction. Numbers following reaction bounds are the optimal fluxes through each reaction when maximizing flux through v4. (B) Same as (A) except one dilution reaction has been added for each metabolite whose flux is constrained to be exactly equal to 0.1% of the sum of the absolute values of all other fluxes that involve that metabolite. (C) Same as in (B) except one leakage reaction has been added connecting each pair of metabolites that exist in two separate compartments. Fluxes through leakage reactions are constrained to be between -1 and 1.
